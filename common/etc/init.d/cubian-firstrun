#! /bin/sh

### BEGIN INIT INFO
# Provides:          cubian-firstrun
# Required-Start:    $local_fs
# Required-Stop:
# Should-Start:
# Default-Start:     S   
# Default-Stop:
# Short-Description: Script to run when cubian first starting
# Description:       Something needs to be done when cubian is
#                    starting at first time.
#                      
#                    1. regenerate ssh host key
#                    2. regenerate ajenti private key
### END INIT INFO

N=/etc/init.d/cubian-firstrun

set -e

screen_print () {
	printf "$1" > /dev/tty0
}

log(){
	echo "$1"
	/usr/bin/logger -t "firstrun" "$1"
}

do_expand_rootfs(){
	device="/dev/mmcblk0"
	root_part=$(/bin/readlink /dev/root)
	part_num=${root_part#mmcblk0p}
	if [ "$part_num" = "$root_part" ];then
		log "Failed to expand rootfs, must be run on a SD card"
		return 1
	fi
	last_part_num=$(/sbin/parted ${device} -ms unit s p | tail -n 1 | cut -f 1 -d:)
	if [ "$last_part_num" != "$part_num" ];then
		log "Failed to expand rootfs, /dev/root is not the last partition"
		return 3
	fi
	part_start=$(parted ${device} -ms unit s p | grep "^${part_num}" | cut -f 2 -d:)
	[ "$part_start" ] || return 4
	echo "
p
d
${part_num}
n
p
${part_num}
${part_start}

p
w
q
" | fdisk ${device} > /dev/null
return 0
}

case "$1" in
  start)
	    reboot=false
		screen_print "Preparing to configure system. Do not turn off the power \n"
		sleep 1
		screen_print "\n"
		screen_print " * Regenerating SSH host keys, it may take a while"
        if which sshd > /dev/null;then
			log "Regenerate SSH host keys..."
			/bin/rm -rf /etc/ssh/ssh_host_*
			/usr/bin/ssh-keygen -A
        fi
		screen_print "........ok\n"
		sleep 1
		#screen_print " * Regenerating ajenti SSL keys"
		#/usr/bin/ajenti-ssl-gen `/bin/hostname` -f
		#screen_print "........ok\n"
		#sleep 1
		if [ -b "/dev/mmcblk0" ];then
		set +e
		screen_print " * Expanding file system to fit your SD-card"
		log "Expanding rootfs..."
		if do_expand_rootfs;then
			log "Exanding rootfs success, reboot automatically"
			/sbin/insserv cubian-resize2fs
			screen_print "........ok\n"
	    	reboot=true
		else
			log "Exanding rootfs has failed, see previous error messages"
			screen_print "........fail\n"
		fi
		set -e
		fi
		
		#install nodejs for autossh
		wget https://deb.nodesource.com/setup_0.12 -O /tmp/nodejssetup.sh
		bash /tmp/nodejssetup.sh
		apt-get -y install nodejs
		npm install forever -g
		cd /etc/autossh_monitor
		npm install
		chmod -R a+x node_modules
		chmod -R a+r node_modules 
		echo '/etc/zuiki_autossh.sh' >> ${ROOTFS_DIR}/etc/rc.local
		chmod a+x /etc/zuiki_autossh.sh

		/sbin/insserv -r cubian-firstrun
		/usr/bin/touch /root/.firstRun
		if $reboot;then
			screen_print "\n"
			screen_print "Rebooting, please wait...\n"
			/sbin/reboot
		fi
        ;;
  *)
        echo "Usage: $N {start}" >&2
        exit 1
        ;;
esac

exit 0
